<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Yêu cầu kết bạn </title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<style>
    body {
        font-family: Arial, sans-serif;
        background-color: #f4f4f4;
        margin: 0;
        padding: 20px;
    }

    h1 {
        text-align: center;
        color: #333;
    }

    ul {
        list-style: none;
        padding: 0;
        max-width: 600px;
        margin: 0 auto;
    }

    li {
        background-color: white;
        padding: 15px;
        margin: 10px 0;
        border: 1px solid #ddd;
        border-radius: 5px;
        display: flex;
        align-items: center;
    }

    .btn-accept {
        background-color: #007bff;
        border: none;
        padding: 8px 12px;
        border-radius: 5px;
        color: white;
        text-decoration: none;
        transition: background-color 0.3s;
        margin-left: auto;
        margin-right: 10px; /* Khoảng cách giữa Accept và Decline */
    }

    .btn-accept:hover {
        border: #007bff solid 1px;
        color: #007bff;
        background-color: white;
    }

    .btn-decline {
        background-color: red;
        border: none;
        padding: 8px 12px;
        border-radius: 5px;
        color: white;
        text-decoration: none;
        transition: background-color 0.3s;
    }

    .btn-decline:hover {
        border: red solid 1px;
        color: red;
        background-color: white;
    }

    .no-results {
        text-align: center;
        color: #888;
        padding: 15px;
    }

    a {
        color: black;
        text-decoration: none;
    }
</style>
<body>
    <h1>
        <a href="{% url 'SocialMedia:index' %}">
            <i class="fa-sharp fa-solid fa-arrow-left"></i>
        </a>
        Yêu cầu kết bạn 
    </h1>

    <ul id="friend-requests-list">
        {% for request in requests %}
            <li id="request-{{ request.id }}">
                {{ request.from_user.username }} 
                <a href="{% url 'SocialMedia:accept_friend_request' request.id %}" class="btn-accept">Chấp nhận</a>
                <a href="{% url 'SocialMedia:decline_friend_request' request.id %}" class="btn-decline">Từ chối</a>
            </li>
        {% empty %}
            <li class="no-results">Không có yêu cầu nào.</li>
        {% endfor %}
    </ul>

    <script>
        const socket = new WebSocket('ws://localhost:8000/ws/notifications/');
    
        socket.onopen = function() {
            console.log("Kết nối WebSocket đã được thiết lập");
        };
    
        socket.onmessage = function(event) {
        const data = JSON.parse(event.data);
        const friendRequestsList = document.getElementById("friend-requests-list");

        if (data.type === 'friend_request_sent') {
            // Thêm yêu cầu kết bạn mới vào danh sách
            const newRequestItem = document.createElement("li");
            newRequestItem.id = `request-${data.request_id}`;
            newRequestItem.innerHTML = `
                ${data.from_user} 
                <a href="/accept_friend_request/${data.request_id}/" class="btn-accept">Chấp nhận</a>
                <a href="/decline_friend_request/${data.request_id}/" class="btn-decline">Từ chối</a>
            `;
            friendRequestsList.appendChild(newRequestItem);
            alert(data.message);

        } else if (data.type === 'friend_request_accepted' || data.type === 'friend_request_declined') {
            const requestId = data.request_id;
            if (requestId) {  // Kiểm tra nếu requestId không null
                const requestElement = document.getElementById(`request-${requestId}`);
                if (requestElement) {
                    requestElement.remove(); // Xóa yêu cầu đã xử lý
                    alert(`Yêu cầu kết bạn đã ${data.type === 'friend_request_accepted' ? 'được chấp nhận' : 'bị từ chối'}.`);
                }
            }
        }
    };
    
        socket.onclose = function(event) {
            console.error('Kết nối WebSocket đã đóng bất ngờ');
        };
    
        socket.onerror = function(error) {
            console.error('Lỗi WebSocket:', error);
            alert('Kết nối đến thông báo không thành công. Vui lòng thử lại sau.');
        };
    </script>
</body>
</html>