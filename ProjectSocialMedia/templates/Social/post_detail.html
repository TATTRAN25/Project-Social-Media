{% extends 'base.html' %}
{% load static %}
<link rel="stylesheet" href="{% static 'assets/css/style_post_detail.css' %}">

{% block body_block %}
<div class="container post-detail-container">
    <h1 class="post-title">Tiêu đề: {{ post.title }}</h1>
    {% if post.image %}
        <img src="{{ post.image.url }}" alt="Hình ảnh bài viết" class="post-image">
    {% else %}
        <p class="no-image">Không có hình ảnh</p>
    {% endif %}
    <p class="post-content">Nội dung: {{ post.content }}</p>
    <p class="post-author"><strong>Tác giả:</strong> {{ post.author.username }}</p>
    
    <div class="post-actions">
        {% if request.user == post.author %}
            <form method="post" action="{% url 'SocialMedia:post_detail' post.id %}">
                {% csrf_token %}
                <button type="submit" class="btn btn-danger post-delete-btn">Xóa Bài Viết</button>
            </form>
            <a href="{% url 'SocialMedia:manage_post_edit' post.id %}" class="btn btn-secondary post-edit-btn">Chỉnh sửa Bài Viết</a>
        {% endif %}
        
        <a href="{% url 'SocialMedia:user_profile' post.author.userprofileinfo.id %}" class="btn btn-primary post-back-btn">Quay lại Trang</a>
        
        <!-- Nút React -->
        <button class="btn btn-success react-button" id="react-button">Phản Ứng</button>
        <div id="reaction-options" style="display: none;">
            <form id="reaction-form" method="post">
                {% csrf_token %}
                <input type="hidden" name="reaction_type" id="reaction-type">
                <div class="reaction-buttons">
                    <button type="button" class="reaction-option" onclick="submitReaction('like')">
                        <i class="fas fa-thumbs-up"></i> Thích &nbsp;<span class="reaction-count" id="like-count">{{ reactions_count.like }}</span>
                    </button>
                    <button type="button" class="reaction-option" onclick="submitReaction('love')">
                        <i class="fas fa-heart"></i> Yêu &nbsp;<span class="reaction-count" id="love-count">{{ reactions_count.love }}</span>
                    </button>
                    <button type="button" class="reaction-option" onclick="submitReaction('sad')">
                        <i class="fas fa-sad-tear"></i> Buồn &nbsp;<span class="reaction-count" id="sad-count">{{ reactions_count.sad }}</span>
                    </button>
                    <button type="button" class="reaction-option" onclick="submitReaction('angry')">
                        <i class="fas fa-angry"></i> Giận dữ &nbsp;<span class="reaction-count" id="angry-count">{{ reactions_count.angry }}</span>
                    </button>
                    <button type="button" class="reaction-option" onclick="submitReaction('wow')">
                        <i class="fas fa-surprise"></i> Wow &nbsp;<span class="reaction-count" id="wow-count">{{ reactions_count.wow }}</span>
                    </button>
                </div>
            </form>
        </div>
    
        <!-- Hiển thị tổng số phản ứng với cảm xúc chi tiết -->
        <span class="total-reaction-count" id="reaction-tooltip" style="display: none;">
            {{ reactions_count.like }} Thích, 
            {{ reactions_count.love }} Yêu, 
            {{ reactions_count.sad }} Buồn, 
            {{ reactions_count.angry }} Giận dữ, 
            {{ reactions_count.wow }} Wow
            (Tổng: {{ post.reaction_set.count }} Phản Ứng)
        </span>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    function showReactions() {
        document.getElementById('reaction-tooltip').style.display = 'inline';
    }

    function hideReactions() {
        document.getElementById('reaction-tooltip').style.display = 'none';
    }

    document.getElementById('react-button').addEventListener('click', function() {
        const options = document.getElementById('reaction-options');
        options.style.display = options.style.display === 'none' ? 'block' : 'none';
    });

    function submitReaction(reaction) {
        document.getElementById('reaction-type').value = reaction;
        
        $.ajax({
            type: 'POST',
            url: "{% url 'SocialMedia:react_to_post' post.id %}",
            data: {
                'reaction_type': reaction,
                'csrfmiddlewaretoken': '{{ csrf_token }}'
            },
            success: function(response) {
                if (response.success) {
                    // Cập nhật số lượng phản ứng
                    document.getElementById('like-count').innerText = response.reactions_count.like;
                    document.getElementById('love-count').innerText = response.reactions_count.love;
                    document.getElementById('sad-count').innerText = response.reactions_count.sad;
                    document.getElementById('angry-count').innerText = response.reactions_count.angry;
                    document.getElementById('wow-count').innerText = response.reactions_count.wow;

                    // Cập nhật tổng số phản ứng
                    document.querySelector('.total-reaction-count').innerText = response.reactions_count.like + response.reactions_count.love + response.reactions_count.sad + response.reactions_count.angry + response.reactions_count.wow + ' Phản Ứng';
                }
            },
            error: function(xhr, status, error) {
                console.error(error);
            }
        });
    }
</script>
{% endblock %}