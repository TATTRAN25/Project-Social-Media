{% extends 'base.html' %}
{% load static %}
<link rel="stylesheet" href="{% static 'assets/css/style_post_detail.css' %}">

{% block body_block %}
<div class="container post-detail-container">
    <h1 class="post-title">{{ post.title }}</h1>
    {% if post.image %}
        <img src="{{ post.image.url }}" alt="Hình ảnh bài viết" class="post-image">
    {% else %}
        <p class="no-image">Không có hình ảnh</p>
    {% endif %}
    <p class="post-content">Nội dung: {{ post.content }}</p>
    <p class="post-author"><strong>Tác giả:</strong> {{ post.author.username }}</p>

    <div class="post-actions">
        {% if request.user == post.author %}
            <form method="post" action="{% url 'SocialMedia:post_detail' post.id %}">
                {% csrf_token %}
                <button type="submit" class="btn btn-danger post-delete-btn" name="delete_post" onclick="return confirm('Bạn có chắc chắn muốn xóa bài viết này không?');">Xóa bài viết</button>
            </form>
            <a href="{% url 'SocialMedia:manage_post_edit' post.id %}" class="btn btn-secondary post-edit-btn">Chỉnh sửa Bài Viết</a>
        {% endif %}
        <a href="{% url 'SocialMedia:user_profile' post.author.userprofileinfo.id %}" class="btn btn-primary post-back-btn">Quay lại Trang</a>

        <button class="btn btn-success react-button" id="react-button">Phản Ứng</button>
        <div id="reaction-options" style="display: none;">
            <form id="reaction-form" method="post">
                {% csrf_token %}
                <input type="hidden" name="reaction_type" id="reaction-type">
                <div class="reaction-buttons">
                    <button type="button" class="reaction-option" onclick="submitReaction('like')">
                        <i class="fas fa-thumbs-up"></i> Thích &nbsp;<span class="reaction-count" id="like-count">{{ reactions_count.like }}</span>
                    </button>
                    <button type="button" class="reaction-option" onclick="submitReaction('love')">
                        <i class="fas fa-heart"></i> Yêu &nbsp;<span class="reaction-count" id="love-count">{{ reactions_count.love }}</span>
                    </button>
                    <button type="button" class="reaction-option" onclick="submitReaction('sad')">
                        <i class="fas fa-sad-tear"></i> Buồn &nbsp;<span class="reaction-count" id="sad-count">{{ reactions_count.sad }}</span>
                    </button>
                    <button type="button" class="reaction-option" onclick="submitReaction('angry')">
                        <i class="fas fa-angry"></i> Giận dữ &nbsp;<span class="reaction-count" id="angry-count">{{ reactions_count.angry }}</span>
                    </button>
                    <button type="button" class="reaction-option" onclick="submitReaction('wow')">
                        <i class="fas fa-surprise"></i> Wow &nbsp;<span class="reaction-count" id="wow-count">{{ reactions_count.wow }}</span>
                    </button>
                </div>
            </form>
        </div>
        
        <span class="total-reaction-count" id="reaction-tooltip" style="display: none;">
            {{ reactions_count.like }} Thích, 
            {{ reactions_count.love }} Yêu, 
            {{ reactions_count.sad }} Buồn, 
            {{ reactions_count.angry }} Giận dữ, 
            {{ reactions_count.wow }} Wow
            (Tổng: {{ post.reaction_set.count }} Phản Ứng)
        </span>
        </div>

        <div class="comments-section-container">
            <div class="comments-section">
                <h3>Bình luận</h3>
                <!-- Hiển thị bình luận -->
                {% for comment in post.comments.all %} {% if comment.parent_comment is None %}
                <!-- Bình luận gốc -->
                <div class="comment mt-3">
                  <strong>{{ comment.author.username }}: {{ comment.content }}</strong>
                  <small class="text-muted">{{ comment.created_at|timesince }} ago<br/></small>
                  {% if comment.image %}
                    <img src="{{ comment.image.url }}" alt="Bình luận hình ảnh" class="img-fluid">
                  {% endif %}

                    <!-- Hiển thị nút Like -->
                    {% if user.is_authenticated %}
                        {% if user != comment.author %}
                        <a href="{% url 'SocialMedia:like_comment' comment.id %}" class="btn btn-outline-primary btn-sm mt-2">
                            Like
                        </a>
                        {% else %}
                            <button class="btn btn-secondary btn-sm mt-2" disabled>Không thể like bình luận của chính bạn</button>
                        {% endif %}
                    {% else %}
                        <button class="btn btn-outline-secondary btn-sm mt-2" disabled>Vui lòng đăng nhập để like</button>
                    {% endif %}

                    <!-- Hiển thị số lượng likes -->
                    <span>{{ comment.likes.count }} Likes <br/></span>
          
                  <!-- Nút chỉnh sửa và xóa bình luận -->
                  {% if comment.author == user or user.is_staff %}
                  <a
                    href="{% url 'SocialMedia:edit_post_comment' comment.id %}"
                    class="btn btn-secondary btn-sm mt-2"
                    >Chỉnh sửa</a
                  >
                  <a
                    href="{% url 'SocialMedia:delete_post_comment' comment.id %}"
                    class="btn btn-danger btn-sm mt-2"
                    onclick="return confirm('Bạn có chắc chắn muốn xóa bình luận này không?');"
                    >Xóa</a
                  >
                  {% endif %}
          
                  <!-- Nút phản hồi bình luận -->
                  {% if user.is_authenticated %}
                  <a
                    href="{% url 'SocialMedia:reply_post_comment' comment.id %}"
                    class="btn btn-info btn-sm mt-2"
                    >Phản hồi</a
                  >
                  {% endif %}
          
                  <!-- Hiển thị các phản hồi -->
                  <div class="replies" style="margin-left: 20px">
                    {% for reply in comment.replies.all %}
                    <div class="reply mt-2">
                      <strong>{{ reply.author.username }}</strong>
                      <p>{{ reply.content }}</p>
                      <small class="text-muted"
                        >{{ reply.created_at|timesince }} ago</small
                      >
          
                      <!-- Các nút xóa và chỉnh sửa cho phản hồi -->
                      {% if reply.author == user or user.is_staff %}
                      <a
                        href="{% url 'SocialMedia:edit_post_comment' reply.id %}"
                        class="btn btn-secondary btn-sm mt-2"
                        >Chỉnh sửa</a
                      >
                      <a
                        href="{% url 'SocialMedia:delete_post_comment' reply.id %}"
                        class="btn btn-danger btn-sm mt-2"
                        onclick="return confirm('Bạn có chắc chắn muốn xóa phản hồi này không?');"
                        >Xóa</a
                      >
                      {% endif %}
                    </div>
                    {% empty %}
                    <p>Chưa có phản hồi nào.</p>
                    {% endfor %}
                  </div>
                </div>
                {% endif %} {% endfor %}
            
                <!-- Form bình luận mới -->
                <h3>Thêm bình luận</h3>
                <form method="POST" enctype="multipart/form-data" action="{% url 'SocialMedia:post_detail' post_id=post.id %}">
                    {% csrf_token %}
                    {{ form.as_p }}
                    <button type="submit" name="comment" class="btn btn-primary">Gửi Bình Luận</button>
                </form>
          </div>
</div>

{% endblock %}

{% block script %}
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    document.getElementById('react-button').addEventListener('click', function() {
        const options = document.getElementById('reaction-options');
        options.style.display = options.style.display === 'none' ? 'block' : 'none';
    });

    function submitReaction(reaction) {
        document.getElementById('reaction-type').value = reaction;
        
        $.ajax({
            type: 'POST',
            url: "{% url 'SocialMedia:react_to_post' post.id %}",
            data: {
                'reaction_type': reaction,
                'csrfmiddlewaretoken': '{{ csrf_token }}'
            },
            success: function(response) {
                if (response.success) {
                    document.getElementById('like-count').innerText = response.reactions_count.like;
                    document.getElementById('love-count').innerText = response.reactions_count.love;
                    document.getElementById('sad-count').innerText = response.reactions_count.sad;
                    document.getElementById('angry-count').innerText = response.reactions_count.angry;
                    document.getElementById('wow-count').innerText = response.reactions_count.wow;

                    document.querySelector('.total-reaction-count').innerText = response.reactions_count.like + response.reactions_count.love + response.reactions_count.sad + response.reactions_count.angry + response.reactions_count.wow + ' Phản Ứng';
                }
            },
            error: function(xhr, status, error) {
                console.error(error);
            }
        });
    }
    
    $(document).ready(function () {
        $(".reply-form").on("submit", function (e) {
            e.preventDefault();

            const form = $(this);
            const url = form.attr("action");

            $.ajax({
                type: "POST",
                url: url,
                data: form.serialize(),
                success: function (response) {
                    if (response.author && response.text && response.created_date) {
                        const newReplyElement = document.createElement("div");
                        newReplyElement.classList.add("reply");
                        newReplyElement.innerHTML = `
                            <strong>${response.author}</strong>: ${response.text}<br>
                            <span class="reply-comment-date">Posted on: ${response.created_date}</span>
                        `;
                        form.closest(".replies").append(newReplyElement);
                        form.find("textarea").val("");
                    } else {
                        alert("Có lỗi xảy ra khi gửi bình luận.");
                    }
                },
                error: function (xhr) {
                    alert("Có lỗi xảy ra khi gửi bình luận.");
                },
            });
        });
    });
</script>
{% endblock %}