{% extends 'base.html' %}

{% load static %}
<link rel="stylesheet" href="{% static 'assets/css/style_post_detail.css' %}">

{% block body_block %}
<div class="container post-detail-container">
    <h1 class="post-title">Ti√™u ƒë·ªÅ: {{ post.title }}</h1>
    {% if post.image %}
        <img src="{{ post.image.url }}" alt="H√¨nh ·∫£nh b√†i vi·∫øt" class="post-image">
    {% else %}
        <p class="no-image">Kh√¥ng c√≥ h√¨nh ·∫£nh</p>
    {% endif %}
    <p class="post-content">N·ªôi dung: {{ post.content }}</p>
    <p class="post-author"><strong>T√°c gi·∫£:</strong> {{ post.author.username }}</p>
    
    <div class="post-actions">
        {% if request.user == post.author %}
            <form method="post" action="{% url 'SocialMedia:post_detail' post.id %}">
                {% csrf_token %}
                <button type="submit" class="btn btn-danger post-delete-btn">X√≥a B√†i Vi·∫øt</button>
            </form>
            <a href="{% url 'SocialMedia:manage_post_edit' post.id %}" class="btn btn-secondary post-edit-btn">Ch·ªânh s·ª≠a B√†i Vi·∫øt</a>
        {% endif %}
        <a href="{% url 'SocialMedia:user_profile' post.author.userprofileinfo.id %}" class="btn btn-primary post-back-btn">Quay l·∫°i Trang</a>
    </div>
</div>

<!-- Ph·∫ßn b√¨nh lu·∫≠n t√°ch ri√™ng ra ngo√†i -->
<div class="comments-section-container">
    <div class="comments-section">
        <h3>B√¨nh lu·∫≠n</h3>
        {% if comments %}
            <ul class="comments-list">
                {% for comment in comments %}
                    <li class="comment">
                        <strong>{{ comment.author.username }}</strong> {{ comment.created_at|timesince}} ago:
                        <p>{{ comment.content }}</p>
                        <!-- Ph·∫ßn react emoji v√† ph·∫£n h·ªìi -->
                        <div class="emoji-wrapper">
                            <button class="reaction-btn default-reaction" data-comment-id="{{ comment.id }}" data-reaction="like">
                                üëç Like
                            </button>
                            <div class="emoji-options" id="emoji-options-{{ comment.id }}" style="display: none;">
                                <button class="reaction-btn" data-comment-id="{{ comment.id }}" data-reaction="like">
                                    üëç Like
                                </button>
                                <button class="reaction-btn" data-comment-id="{{ comment.id }}" data-reaction="haha">
                                    üòÇ Haha
                                </button>
                                <button class="reaction-btn" data-comment-id="{{ comment.id }}" data-reaction="sad">
                                    üò¢ Sad
                                </button>
                                <button class="reaction-btn" data-comment-id="{{ comment.id }}" data-reaction="angry">
                                    üò° Angry
                                </button>
                            </div>
                        </div>
                        <form method="POST" action="{% url 'SocialMedia:reply_comment' comment.id %}" class="reply-form">
                            {% csrf_token %}
                            {{ form.content }}
                            <button type="submit" class="btn btn-primary">Reply</button>
                        </form>
  
                        <button class="btn-show-reply btn-secondary toggle-replies">Show Replies</button>
                        
                        <!-- Hi·ªÉn th·ªã b√¨nh lu·∫≠n tr·∫£ l·ªùi -->
                        <div class="replies">
                            {% for reply in comment.replies.all %}
                                <div class="reply">
                                    <strong>{{ reply.author.username }}</strong>: {{ reply.content }}<br>
                                    <span class="reply-comment-date">Posted on: {{ reply.created_date|timesince }}</span>
                                  </div>
                            {% empty %}
                                <p>No replies yet.</p>
                            {% endfor %}
                        </div>
  
                        {% if request.user.is_authenticated %} 
                            {% if request.user.is_staff or request.user == comment.author %}
                                <form method="POST" action="{% url 'SocialMedia:delete_comment' comment.id %}" style="display: inline">
                                {% csrf_token %}
                                    <button type="submit" class="btn btn-link delete-button" title="Delete comment">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </form>
                            {% endif %}
                        {% endif %}
                    </li>
                {% endfor %}
            </ul>
        {% else %}
            <p>Ch∆∞a c√≥ b√¨nh lu·∫≠n n√†o.</p>
        {% endif %}

        <!-- Form b√¨nh lu·∫≠n -->
        <h4>Th√™m B√¨nh Lu·∫≠n</h4>
        <form method="POST">
            {% csrf_token %}
            {{ form.as_p }}
            <button type="submit" class="btn btn-primary">G·ª≠i B√¨nh Lu·∫≠n</button>
        </form>
    </div>
</div>

{% endblock %}

{% block script %}
<script>
    document.addEventListener("DOMContentLoaded", function() {
        // X·ª≠ l√Ω m·ªü/ƒë√≥ng form ph·∫£n h·ªìi
        const replyButtons = document.querySelectorAll(".reply-btn");
        replyButtons.forEach(button => {
            button.addEventListener("click", function() {
                const commentId = this.getAttribute("data-comment-id");
                const replyForm = document.getElementById(`reply-form-${commentId}`);
                
                // Toggle form ph·∫£n h·ªìi (hi·ªán/·∫©n)
                if (replyForm.style.display === "none" || replyForm.style.display === "") {
                    replyForm.style.display = "block";  // Hi·ªÉn th·ªã form ph·∫£n h·ªìi
                } else {
                    replyForm.style.display = "none";   // ·∫®n form ph·∫£n h·ªìi
                }
            });
        });
    
        document.addEventListener("DOMContentLoaded", function() {
            // X·ª≠ l√Ω hi·ªÉn th·ªã c√°c emoji khi r√™ chu·ªôt v√†o bi·ªÉu t∆∞·ª£ng ch√≠nh
            const emojiWrappers = document.querySelectorAll('.emoji-wrapper');
            emojiWrappers.forEach(wrapper => {
                const reactionButton = wrapper.querySelector('.reaction-btn');
                const emojiOptions = wrapper.querySelector('.emoji-options');
        
                // Khi r√™ chu·ªôt v√†o bi·ªÉu t∆∞·ª£ng ch√≠nh (like), hi·ªÉn th·ªã c√°c emoji
                reactionButton.addEventListener('mouseenter', function() {
                    emojiOptions.style.display = 'block';
                });
        
                // Khi chu·ªôt r·ªùi kh·ªèi, ·∫©n c√°c emoji ƒëi
                wrapper.addEventListener('mouseleave', function() {
                    emojiOptions.style.display = 'none';
                });
            });
        
            // X·ª≠ l√Ω ch·ªçn m·ªôt emoji
            const reactionButtons = document.querySelectorAll('.reaction-btn');
            reactionButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const commentId = this.getAttribute('data-comment-id');
                    const reaction = this.getAttribute('data-reaction');
                    const emojiWrapper = document.querySelector(`#emoji-options-${commentId}`);
                    const defaultButton = emojiWrapper.querySelector('.default-reaction');
        
                    // ƒê√°nh d·∫•u emoji ƒë√£ ch·ªçn (s√°ng l√™n)
                    const selectedButton = emojiWrapper.querySelector(`[data-reaction="${reaction}"]`);
                    selectedButton.classList.add('selected'); // Th√™m l·ªõp 'selected' cho emoji ƒë√£ ch·ªçn
        
                    // Thay ƒë·ªïi bi·ªÉu t∆∞·ª£ng m·∫∑c ƒë·ªãnh (v√≠ d·ª•: like) th√†nh emoji ƒë√£ ch·ªçn
                    defaultButton.innerHTML = selectedButton.innerHTML;  // Thay n·ªôi dung c·ªßa n√∫t Like th√†nh emoji ƒë√£ ch·ªçn
        
                    // G·ª≠i d·ªØ li·ªáu ph·∫£n ·ª©ng ƒë·∫øn backend (c√≥ th·ªÉ d√πng AJAX ƒë·ªÉ g·ª≠i)
                    console.log(`Reacted on comment ${commentId} with ${reaction}`);
                });
            });
        });        
    });     
    $(document).ready(function() {
        $('.reply-form').on('submit', function(e) {
            e.preventDefault(); // NgƒÉn ch·∫∑n form submit th√¥ng th∆∞·ªùng
    
            const form = $(this);
            const url = form.attr('action'); // L·∫•y URL t·ª´ action c·ªßa form
    
            $.ajax({
                type: 'POST',
                url: url,
                data: form.serialize(), // Serialize data c·ªßa form
                success: function(response) {
                    // Ki·ªÉm tra n·∫øu response c√≥ ch·ª©a d·ªØ li·ªáu ph·∫£n h·ªìi
                    if (response.author && response.text && response.created_date) {
                        // T·∫°o ph·∫ßn t·ª≠ HTML cho ph·∫£n h·ªìi m·ªõi
                        const newReplyElement = document.createElement('div');
                        newReplyElement.classList.add('reply');
                        newReplyElement.innerHTML = `
                            <strong>${response.author}</strong>: ${response.text}<br>
                            <span class="reply-comment-date">Posted on: ${response.created_date}</span>
                        `;
    
                        // Th√™m ph·∫ßn t·ª≠ reply m·ªõi v√†o cu·ªëi danh s√°ch reply
                        form.closest('.replies').append(newReplyElement);
    
                        // X√≥a n·ªôi dung c·ªßa form sau khi g·ª≠i b√¨nh lu·∫≠n th√†nh c√¥ng
                        form.find('textarea').val('');
                    } else {
                        alert("C√≥ l·ªói x·∫£y ra khi g·ª≠i b√¨nh lu·∫≠n.");
                    }
                },
                error: function(xhr) {
                    alert('C√≥ l·ªói x·∫£y ra khi g·ª≠i b√¨nh lu·∫≠n.');
                }
            });
        });
    });
</script>
{% endblock %}